# 实验1：利用Socket，编写一个聊天程序

学号：1811494

姓名：刘旭萌

## 0. 摘要

本次实验利用C++语言，编写了基于$TCP$的流式$SOCKET$的简易聊天室。利用$Winsock2.h$头文件编写了一个$WIN32$平台下的程序。该程序可以完成指定人数聊天室的创建，程序主要分为服务器端和客户端，服务器端负责接收客户端消息，解析报文，并将其转发至对应的接收者。在客户端程序中利用多线程编程，可以使消息的收和发之间不相互影响，可以连续发送多条消息，也可以连续接收多条消息。

## 1. 聊天协议说明

### 报文格式

本次实验进行了报文格式的简要设计，其内容为**发送方+接收方+消息内容**，在传输过程中采用字符串**char\***格式，为了方便解析，我还定义了```msg_form```类，方便报文内容的提取：

```C++
class msg_form
{
public:

	char from_name;//发送方标号
	char to_name;//接收方
	char msg[BUF_SIZE];//消息内容
```

注：本次实验只是**简要设计**，没有加入帧校验码等其它内容，并且只用了**一个字节代表不同的客户端**。在实际操作过程中，不同的客户端应用不同IP地址和端口号区分。

为了方便```msg_form```和```char*```之间的转换，定义了两个函数

```C++
char* msg_to_string(msg_form a);//用字符串存储报文
msg_form string_to_msg(char a[]);//将字符串恢复成类
```

通过类型转换，我们可以更加方便快捷的设置和提取报文中的信息

### 聊天过程

- 设置聊天室人数CLIENTNUM

- 先开启服务器端(server.cpp)，建立socket，绑定ip和端口号，进入**监听**模式进行等待

- 开启客户端程序，设置相关信息，对服务器发出**connect请求**
- 服务器**accept**客户端的连接请求，并建立专属的连接通道，返回给客户端**编号信息**，等到达到预设的聊天人数即可开始聊天
- 客户端每次输入的消息格式为**收信方编号+消息内容**，在发送之前，该字符串前会被添加上**发送者的编号**。所以实际sendBuf中的内容为**发送和编号+收信方编号+消息内容**
- 服务器接收到信息后进行**解析**得到**目的地址**（本次程序简化为编号而不是ip），并有针对性的进行转发
- 当用户想要退出聊天室时，输入**任意编号+quit**即可退出程序，当服务端检测到**在线人数为0时，自动退出程序**

## 2. 编程程序说明

- 本程序基于**WinSock2.h**进行编写，并且需要链接**ws2_32.lib库**到此项目中

  ```C++
  #include <WinSock2.h>//windows socket 编程头文件
  #pragma comment(lib,"ws2_32.lib")//链接ws2_32.lib库文件到此项目中
  ```
  
- **加载socket库**，并约定使用的**socket版本**，对其进行**初始化**

  ```C++
  //加载socket库
  WSADATA wsaData;
  //MAKEWORD(2.2),成功返回0
  if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0)
  {
      cout << "socket初始化失败" << endl;
      return 0;
  }
  ```

- **创建socket**

  ```C++
  //创建一个socket，并将该socket绑定到一个特定的传输层
  SOCKET sockSer = socket(AF_INET, SOCK_STREAM, 0);//地址类型（ipv4），服务类型（流式套接字）
  ```

- 对**端口和ip地址进行初始化**

  ```C
  //初始化地址
  addrSer.sin_addr.s_addr = inet_addr("192.168.89.1");//本机ip地址中的一个
  addrSer.sin_family = AF_INET;//使用ipv4
  addrSer.sin_port = htons(PORT);//指定端口号，这是PORT=6666（可以打开的任意端口即可）
  ```

- 

## 3. 对话界面展示和对话的退出





